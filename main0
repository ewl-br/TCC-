from senha import API_KEY
from flask import Flask, request, jsonify
from openai import OpenAI
from flask_cors import CORS
import json

client = OpenAI(api_key=API_KEY)
app = Flask(__name__)
CORS(app)

# outras funçoes(da ia e dos ssa)

def gerar_plano_com_ia(materias, prova):
    prompt = f"""
    Estou criando um plano de estudos para {prova}.
    O usuário escolheu os materias: {', '.join(materias)}.
    Gere uma lista de assuntos para revisar e um plano de estudos simples com horários.
    Responda no formato JSON com as chaves:
    - "plano_de_estudo": lista de strings com os horários
    - "assuntos_sugeridos": dicionário onde cada tema é uma lista de assuntos
    """

    try:
        response = client.chat.completions.create(
            model="gpt-5",
            messages=[
                {"role": "system", "content": f"Você é uma assistente pedagógica especialista em {prova}."},
                {"role": "user", "content": prompt}
            ],
            response_format={"type": "json_object"}  
        )
        conteudo = response.choices[0].message.content
        return json.loads(conteudo) 
    except Exception as e:
        return {"erro": f"Falha ao gerar resposta da IA: {str(e)}"}
    
def gerar_resposta_ssa(nome, lista_assuntos):
    if request.method == "POST":
        dados = request.get_json() or {}
        materias = dados.get("materias", [])
    else:
        materias = request.args.getlist("materias")

    conteudo_ia = gerar_plano_com_ia(materias, nome)
    filtrados = [item for item in lista_assuntos if not materias or item["area"] in materias]

    return jsonify({
        "materias_recebidos": materias,
        "plano_de_estudo": [f"{item['area']} - 19:00 às 20:00" for item in filtrados],
        "assuntos_sugeridos": filtrados,
        "resposta_ia": conteudo_ia
    })

# rotas(Enem,ssa1,ssa2,ss3 e avaliação escolar)

@app.route("/")
def home():
    return "API de Plano de Estudos para ENEM,SSA1,SSA2,SSA3 e avaliação escolar acesse as urls /enem,/ssa1, /ssa2, /ssa3 ou /avaliacao"

@app.route("/enem", methods=["POST", "GET"])
def enem():
    #Entrada
    if request.method == "POST":
        dados = request.get_json() or {}
        materias = dados.get("materias", [])
    else:
        materias = request.args.getlist("materias")

    if not materias:
        return jsonify({"erro": "Nenhum materias selecionado."}), 400

    #Chamar a IA
    conteudo_ia = gerar_plano_com_ia(materias, "ENEM")

    # Garante que sempre retorne um dicionário
    if not isinstance(conteudo_ia, dict):
        return jsonify({
            "erro": "A IA não retornou no formato esperado.",
            "resposta_bruta": conteudo_ia
        }), 500

    #retorno da IA
    return jsonify({
        "materias_recebidos": materias,
        "plano_de_estudo": conteudo_ia.get("plano_de_estudo", []),
        "assuntos_sugeridos": conteudo_ia.get("assuntos_sugeridos", {}),
        "resposta_completa": conteudo_ia
    })

#Rotas SSA usam a função genérica
@app.route("/ssa1", methods=["POST", "GET"])
def ssa1():
    if request.method == "POST":
        dados = request.get_json() or {}
        materias = dados.get("materias",[])
    else:
        materias = request.args.getlist("materias")
    if not materias:
        return jsonify("nenhuma materias escolhida")
    
    conteudo_ia = gerar_plano_com_ia(materias,"ssa1")

    if not isinstance(conteudo_ia, dict):
        return jsonify({
            "erro": "A IA não retornou no formato esperado.",
            "resposta_bruta": conteudo_ia
        }), 500

    #retorno da IA
    return jsonify({
        "materias_recebidos": materias,
        "plano_de_estudo": conteudo_ia.get("plano_de_estudo", []),
        "assuntos_sugeridos": conteudo_ia.get("assuntos_sugeridos", {}),
        "resposta_completa": conteudo_ia
    })

@app.route("/ssa2", methods=["POST", "GET"])
def ssa2():
    if request.method == "POST":
        dados = request.get_json() or {}
        materias = dados.get("materias",[])
    else:
        materias = request.args.getlist("materias")
    if not materias:
        return jsonify("nenhuma materias escolhida")
    
    conteudo_ia = gerar_plano_com_ia(materias ,"ssa1")
    
    if not isinstance(conteudo_ia, dict):
        return jsonify({
            "erro": "A IA não retornou no formato esperado.",
            "resposta_bruta": conteudo_ia
        }), 500

    #retorno da IA
    return jsonify({
        "materias_recebidos": materias,
        "plano_de_estudo": conteudo_ia.get("plano_de_estudo", []),
        "assuntos_sugeridos": conteudo_ia.get("assuntos_sugeridos", {}),
        "resposta_completa": conteudo_ia
    })


@app.route("/ssa3", methods=["POST", "GET"])
def ssa3():
    if request.method == "POST":
        dados = request.get_json() or {}
        materias = dados.get("materias", [])
    else:
        materias = request.args.getlist("materias")

    if not materias:
        return jsonify({"erro": "Nenhum materias selecionado."}), 400

    #Chamar a IA
    conteudo_ia = gerar_plano_com_ia(materias, "ENEM")

    # Garante que sempre retorne um dicionário
    if not isinstance(conteudo_ia, dict):
        return jsonify({
            "erro": "A IA não retornou no formato esperado.",
            "resposta_bruta": conteudo_ia
        }), 500

    #retorno da IA
    return jsonify({
        "materias_recebidos": materias,
        "plano_de_estudo": conteudo_ia.get("plano_de_estudo", []),
        "assuntos_sugeridos": conteudo_ia.get("assuntos_sugeridos", {}),
        "resposta_completa": conteudo_ia
    })
    
@app.route("/avaliacao", methods=["POST", "GET"])
def avaliacao():
    if request.method == "POST":
        dados = request.get_json() or {}
        materias = dados.get("materias", [])
    else:
        materias = request.args.getlist("materias")

    if not materias:
        return jsonify({"erro": "Nenhuma matéria selecionada."}), 400

    conteudo_ia = gerar_plano_com_ia(materias, "Avaliação Escolar")

    return jsonify({
        "materias_recebidas": materias,
        "plano_de_estudo": [f"{materia} - 19:00 às 20:00" for materia in materias],
        "resposta_ia": conteudo_ia
    })

#Função para SSA 

if __name__ == "__main__":
    app.run(debug=True)
